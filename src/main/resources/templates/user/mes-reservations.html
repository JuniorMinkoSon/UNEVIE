<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Réservations | UneVie</title>
</head>

<body>
    <div th:replace="~{fragments/user-layout :: layout(~{::content})}">
        <div th:fragment="content">

            <div class="mb-10">
                <h1 class="text-4xl font-extrabold text-slate-800">Mes Réservations</h1>
                <p class="text-slate-500 mt-2">Suivez l'état de vos réservations en temps réel</p>

                <div th:if="${param.success != null && param.success[0] == 'eval'}"
                    class="mt-6 p-4 bg-emerald-50 border border-emerald-100 text-emerald-600 rounded-2xl flex items-center gap-3 animate-bounce">
                    <i class="fa-solid fa-circle-check"></i>
                    <span class="font-bold">Merci ! Votre évaluation a été enregistrée avec succès.</span>
                </div>
            </div>

            <!-- Filter Tabs (Visual only for now) -->
            <div class="flex gap-4 mb-8 overflow-x-auto pb-2">
                <button
                    class="px-6 py-3 bg-premium-orange text-white font-bold rounded-xl whitespace-nowrap">Toutes</button>
                <button
                    class="px-6 py-3 bg-white text-slate-600 font-bold rounded-xl hover:bg-slate-50 whitespace-nowrap">En
                    attente</button>
                <button
                    class="px-6 py-3 bg-white text-slate-600 font-bold rounded-xl hover:bg-slate-50 whitespace-nowrap">Confirmées</button>
            </div>

            <!-- Reservations Grid -->
            <div th:if="${reservations.empty}" class="bg-white rounded-3xl p-16 text-center shadow-lg">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fa-solid fa-calendar-day text-slate-400 text-4xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Aucune réservation</h3>
                <p class="text-slate-500 mb-8">Vous n'avez pas encore effectué de réservation.</p>
                <a th:href="@{/reservation/secteurs}"
                    class="px-8 py-3 bg-premium-orange text-white font-bold rounded-xl hover:bg-orange-600 transition-all">
                    Découvrir les services
                </a>
            </div>

            <div th:unless="${reservations.empty}" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div th:each="r : ${reservations}"
                    class="bg-white rounded-3xl overflow-hidden shadow-lg border border-slate-100 flex flex-col">
                    <div class="p-6 flex-grow">
                        <div class="flex items-center justify-between mb-4">
                            <span class="px-3 py-1 bg-slate-100 text-slate-500 text-xs font-bold rounded-full"
                                th:text="${#temporals.format(r.dateReservation, 'dd MMM yyyy')}">Date</span>

                            <span th:if="${r.statut.name() == 'EN_COURS'}"
                                class="px-3 py-1 bg-blue-100 text-blue-600 text-xs font-bold rounded-full">En
                                attente</span>
                            <span th:if="${r.statut.name() == 'ACCEPTE'}"
                                class="px-3 py-1 bg-emerald-100 text-emerald-600 text-xs font-bold rounded-full">Confirmée</span>
                            <span th:if="${r.statut.name() == 'REFUSE'}"
                                class="px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full">Refusée</span>
                            <span th:if="${r.statut.name() == 'TERMINE'}"
                                class="px-3 py-1 bg-slate-500 text-white text-xs font-bold rounded-full">Terminée</span>
                        </div>

                        <h3 class="text-xl font-bold text-slate-800 mb-2" th:text="${r.service.nom}">Nom du Service</h3>
                        <p class="text-slate-500 text-sm flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-store text-premium-orange"></i>
                            <span th:text="${r.fournisseur.nomEntreprise}">Fournisseur</span>
                        </p>

                        <div class="bg-slate-50 rounded-2xl p-4 space-y-3 mt-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-slate-400">Date du service</span>
                                <span class="text-slate-800 font-bold"
                                    th:text="${#temporals.format(r.dateService, 'dd/MM/yyyy')}">12/05/2024</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-slate-400">Montant total</span>
                                <span class="text-premium-orange font-extrabold"
                                    th:text="${#numbers.formatDecimal(r.montant, 0, 'COMMA', 0, 'POINT')} + ' FCFA'">50,000
                                    FCFA</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border-t border-slate-100 flex gap-2">
                        <a th:href="@{/reservation/details/{id}(id=${r.id})}"
                            class="flex-1 text-center py-2 bg-white text-slate-800 font-bold rounded-xl border border-slate-200 hover:bg-slate-100 transition-all text-sm">
                            Voir Détails
                        </a>
                        <a th:if="${r.statut.name() == 'ACCEPTE'}" href="#"
                            class="flex-1 text-center py-2 bg-premium-orange text-white font-bold rounded-xl hover:bg-orange-600 transition-all text-sm">
                            Payer
                        </a>
                        <button th:if="${r.statut.name() == 'TERMINE' && !evaluatedIds.contains(r.id)}"
                            th:data-res-id="${r.id}" th:data-service-nom="${r.service.nom}"
                            th:data-service-id="${r.service.id}"
                            onclick="openEvalModal(this.getAttribute('data-res-id'), this.getAttribute('data-service-nom'), this.getAttribute('data-service-id'))"
                            class="flex-1 text-center py-2 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition-all text-sm">
                            Évaluer
                        </button>
                        <span th:if="${r.statut.name() == 'TERMINE' && evaluatedIds.contains(r.id)}"
                            class="flex-1 text-center py-2 bg-slate-100 text-slate-400 font-bold rounded-xl text-sm italic">
                            Déjà évalué
                        </span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- EVALUATION MODAL -->
    <div id="evalModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">Évaluer le service</h2>
            <p id="evalServiceName" class="text-premium-orange font-bold mb-6">Service Name</p>

            <form th:action="@{/evaluation/submit}" method="POST" class="space-y-6">
                <input type="hidden" name="reservationId" id="evalResId">
                <input type="hidden" name="serviceId" id="evalServiceId">

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Votre note (1-5)</label>
                    <div class="flex gap-4">
                        <label th:each="i : ${#numbers.sequence(1, 5)}" class="cursor-pointer">
                            <input type="radio" name="note" th:value="${i}" class="sr-only peer" required>
                            <div
                                class="w-12 h-12 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 font-bold peer-checked:bg-premium-orange peer-checked:text-white transition-all">
                                <span th:text="${i}"></span>
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Votre commentaire</label>
                    <textarea name="commentaire" rows="4"
                        class="w-full bg-slate-50 border-none rounded-2xl p-4 focus:ring-2 focus:ring-premium-orange"
                        placeholder="Comment s'est passée votre expérience ?"></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="button" onclick="closeEvalModal()"
                        class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl">Annuler</button>
                    <button type="submit"
                        class="flex-1 py-3 bg-premium-orange text-white font-bold rounded-xl shadow-lg shadow-premium-orange/20">Envoyer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openEvalModal(resId, serviceName, serviceId) {
            document.getElementById('evalResId').value = resId;
            document.getElementById('evalServiceId').value = serviceId;
            document.getElementById('evalServiceName').innerText = serviceName;
            document.getElementById('evalModal').classList.remove('hidden');
        }

        function closeEvalModal() {
            document.getElementById('evalModal').classList.add('hidden');
        }
    </script>
</body>

</html>