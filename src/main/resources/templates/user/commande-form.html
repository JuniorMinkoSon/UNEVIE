<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Commander - UNEVIE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        premium: {
                            orange: '#f97316',
                            dark: '#1a1a1a',
                            light: '#fdfcfb',
                            accent: '#fbbf24'
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .operator-card.active {
            border-color: #f97316;
            background-color: rgba(249, 115, 22, 0.05);
            box-shadow: 0 0 0 2px #f97316;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-premium-light text-premium-dark font-sans min-h-screen">

    <div th:replace="~{fragments/header :: header}"></div>

    <main class="max-w-3xl mx-auto py-32 px-6">
        <div class="bg-white rounded-[3.5rem] shadow-sm border border-premium-dark/5 overflow-hidden">
            <!-- Header Section -->
            <div class="p-10 md:p-14 space-y-10 border-b border-premium-dark/5">
                <div class="space-y-2 text-center md:text-left">
                    <h1 class="text-3xl font-extrabold tracking-tight">Finaliser votre commande</h1>
                    <p class="text-premium-dark/40">Presque fini ! Remplissez les d√©tails pour valider votre demande.
                    </p>
                </div>

                <div
                    class="flex items-center gap-6 bg-premium-dark p-6 rounded-[2.5rem] text-white overflow-hidden relative group">
                    <div class="absolute inset-0 opacity-10 mix-blend-soft-light pointer-events-none"
                        style="background-image: url('https://www.transparenttextures.com/patterns/az-subtle.png');">
                    </div>
                    <div class="relative z-10 shrink-0">
                        <img th:if="${produit.imageUrl}" th:src="@{'/uploads/' + ${produit.imageUrl}}"
                            class="w-20 h-20 object-cover rounded-2xl border-2 border-white/10 group-hover:scale-105 transition-transform duration-500">
                        <div th:unless="${produit.imageUrl}"
                            class="w-20 h-20 bg-white/10 rounded-2xl flex items-center justify-center border-2 border-white/5">
                            <i class="fa-solid fa-image text-white/20 text-2xl"></i>
                        </div>
                    </div>
                    <div class="relative z-10 space-y-1">
                        <h2 class="font-bold text-xl leading-none" th:text="${produit.nom}">Nom du produit</h2>
                        <div class="text-premium-orange font-extrabold text-2xl"
                            th:text="${#numbers.formatDecimal(produit.prix, 0, 'COMMA', 0, 'POINT') + ' FCFA'}">1,000
                            FCFA</div>
                    </div>
                </div>

                <!-- Stepper Indicator -->
                <div class="flex justify-between items-center px-4 relative">
                    <div class="absolute top-4 left-0 w-full h-0.5 bg-premium-dark/5 -z-10"></div>
                    <div id="step-1-indicator" class="flex flex-col items-center space-y-3">
                        <div
                            class="w-8 h-8 rounded-full bg-premium-orange text-white flex items-center justify-center font-bold shadow-lg shadow-premium-orange/20 ring-4 ring-white transition-all duration-300">
                            1 </div>
                        <span
                            class="text-[10px] font-bold uppercase tracking-widest text-premium-dark/40">Informations</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-premium-dark/5 relative -top-3">
                        <div id="progress-bar"
                            class="h-full bg-premium-orange w-0 transition-all duration-500 rounded-full"></div>
                    </div>
                    <div id="step-2-indicator"
                        class="flex flex-col items-center space-y-3 opacity-30 transition-all duration-500">
                        <div
                            class="w-8 h-8 rounded-full bg-premium-dark/10 text-premium-dark/40 flex items-center justify-center font-bold ring-4 ring-white">
                            2 </div>
                        <span
                            class="text-[10px] font-bold uppercase tracking-widest text-premium-dark/40">Paiement</span>
                    </div>
                </div>
            </div>

            <form th:action="@{/commande/valider}" th:object="${commande}" method="post" id="commandeForm"
                class="p-10 md:p-14">
                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                <input type="hidden" name="produitId" th:value="${produit.id}">
                <input type="hidden" th:field="*{operateur}" id="hidden-operateur">
                <!-- GPS Coordinates -->
                <input type="hidden" name="lat" id="hidden-lat">
                <input type="hidden" name="lng" id="hidden-lng">

                <!-- STEP 1: Infos & Options -->
                <div id="step-1" class="space-y-8 animate-fade-in">
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-premium-dark/60 uppercase tracking-widest pl-1">Nom &
                                Pr√©noms</label>
                            <input type="text" th:field="*{nomClient}" required id="input-nom"
                                class="w-full px-6 py-4 bg-premium-dark/5 border-transparent border-2 rounded-2xl focus:bg-white focus:border-premium-orange outline-none transition-all placeholder:text-premium-dark/20 text-lg font-medium"
                                th:classappend="${#fields.hasErrors('nomClient')} ? '!border-red-500 ring-4 ring-red-500/10' : ''"
                                placeholder="Ex: Jean Kouadio">
                            <p th:if="${#fields.hasErrors('nomClient')}" th:errors="*{nomClient}"
                                class="text-red-500 text-xs font-bold pl-4 mt-2"></p>
                        </div>

                        <div class="space-y-2">
                            <label
                                class="text-sm font-bold text-premium-dark/60 uppercase tracking-widest pl-1">T√©l√©phone</label>
                            <input type="tel" th:field="*{telephone}" required id="input-tel"
                                class="w-full px-6 py-4 bg-premium-dark/5 border-transparent border-2 rounded-2xl focus:bg-white focus:border-premium-orange outline-none transition-all placeholder:text-premium-dark/20 text-lg font-medium"
                                th:classappend="${#fields.hasErrors('telephone')} ? '!border-red-500 ring-4 ring-red-500/10' : ''"
                                placeholder="Ex: 07 00 00 00 00">
                            <p th:if="${#fields.hasErrors('telephone')}" th:errors="*{telephone}"
                                class="text-red-500 text-xs font-bold pl-4 mt-2"></p>
                        </div>

                        <!-- üöó Champs Sp√©cifiques Voiture -->
                        <div id="fields-voiture"
                            class="hidden space-y-6 p-8 bg-premium-orange/5 rounded-[2.5rem] border border-premium-orange/10">
                            <h3
                                class="font-extrabold text-premium-orange text-sm uppercase tracking-widest flex items-center gap-3">
                                <i class="fa-solid fa-car text-xl"></i> Options V√©hicule
                            </h3>
                            <label
                                class="flex items-center gap-4 cursor-pointer group bg-white p-4 rounded-xl border border-transparent hover:border-premium-orange/20 transition-all">
                                <div class="relative w-6 h-6 shrink-0">
                                    <input type="checkbox" th:field="*{avecChauffeur}"
                                        class="peer appearance-none w-6 h-6 border-2 border-premium-dark/10 rounded-lg checked:bg-premium-orange checked:border-premium-orange transition-all cursor-pointer">
                                    <i
                                        class="fas fa-check absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[10px] text-white opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none"></i>
                                </div>
                                <span
                                    class="font-bold text-premium-dark group-hover:text-premium-orange transition-colors">Service
                                    avec chauffeur</span>
                            </label>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-premium-orange/60 uppercase tracking-widest">Lieu
                                    de prise en charge</label>
                                <input type="text" th:field="*{lieuPriseEnCharge}" placeholder="Ex: A√©roport, H√¥tel..."
                                    class="w-full px-5 py-3 bg-white border-2 border-transparent rounded-xl outline-none focus:border-premium-orange transition-all font-medium">
                            </div>
                        </div>

                        <!-- üè† Champs Sp√©cifiques R√©sidence -->
                        <div id="fields-residence"
                            class="hidden space-y-6 p-8 bg-premium-orange/5 rounded-[2.5rem] border border-premium-orange/10">
                            <h3
                                class="font-extrabold text-premium-orange text-sm uppercase tracking-widest flex items-center gap-3">
                                <i class="fa-solid fa-house text-xl"></i> Options R√©sidence
                            </h3>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-premium-orange/60 uppercase tracking-widest">Nombre
                                    de jours</label>
                                <input type="number" th:field="*{nombreJours}" min="1" value="1"
                                    class="w-full px-5 py-3 bg-white border-2 border-transparent rounded-xl outline-none focus:border-premium-orange transition-all font-medium">
                            </div>
                        </div>

                        <!-- üçó Champs Sp√©cifiques Poulet -->
                        <div id="fields-poulet"
                            class="hidden space-y-6 p-8 bg-black/5 rounded-[2.5rem] border border-black/5">
                            <h3
                                class="font-extrabold text-premium-dark text-sm uppercase tracking-widest flex items-center gap-3">
                                <i class="fa-solid fa-drumstick-bite text-xl"></i> Quantit√©
                            </h3>
                            <input type="number" th:field="*{quantite}" min="1" value="1"
                                class="w-full px-5 py-3 bg-white border-2 border-transparent rounded-xl outline-none focus:border-premium-orange transition-all font-medium">
                        </div>

                        <div class="space-y-2" id="field-localisation-general">
                            <div class="flex items-center justify-between pl-1">
                                <label
                                    class="text-sm font-bold text-premium-dark/60 uppercase tracking-widest">Localisation
                                    / Adresse</label>
                                <button type="button" id="btn-geolocation"
                                    class="text-[10px] font-bold text-premium-orange uppercase tracking-widest flex items-center gap-2 hover:text-premium-dark transition-colors">
                                    <i class="fa-solid fa-location-dot"></i> Ma position
                                </button>
                            </div>
                            <input type="text" th:field="*{localisation}" required id="input-loc"
                                class="w-full px-6 py-4 bg-premium-dark/5 border-transparent border-2 rounded-2xl focus:bg-white focus:border-premium-orange outline-none transition-all placeholder:text-premium-dark/20 text-lg font-medium"
                                th:classappend="${#fields.hasErrors('localisation')} ? '!border-red-500 ring-4 ring-red-500/10' : ''"
                                placeholder="Ex: Cocody Angr√©, Rue L15">
                            <p th:if="${#fields.hasErrors('localisation')}" th:errors="*{localisation}"
                                class="text-red-500 text-xs font-bold pl-4 mt-2"></p>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-bold text-premium-dark/60 uppercase tracking-widest pl-1">Mode de
                                Paiement</label>
                            <div class="relative">
                                <select th:field="*{modePaiement}" id="payment-select"
                                    class="w-full px-6 py-4 bg-premium-dark/5 border-transparent border-2 rounded-2xl focus:bg-white focus:border-premium-orange outline-none transition-all cursor-pointer text-lg font-bold appearance-none">
                                    <option value="CASH">Esp√®ces (√† la livraison)</option>
                                    <option value="TELEPHONE">Mobile Money (Wave, Orange, MTN, Moov)</option>
                                </select>
                                <i
                                    class="fas fa-chevron-down absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-premium-dark/20"></i>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="button" id="btn-next"
                            class="w-full bg-premium-orange text-white font-bold py-5 rounded-2xl transition-all shadow-xl shadow-premium-orange/20 text-lg hover:bg-premium-dark active:scale-95 group">
                            Passer au paiement <i
                                class="fa-solid fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <!-- STEP 2: Paiement / Validation -->
                <div id="step-2" class="hidden space-y-10 animate-fade-in transition-all duration-500">
                    <div id="payment-mobile" class="hidden space-y-10">
                        <div class="text-center space-y-6">
                            <h3 class="text-xl font-bold">S√©lectionnez votre op√©rateur</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <button type="button"
                                    class="operator-card p-4 bg-white border-2 border-premium-dark/5 rounded-2xl transition-all hover:bg-premium-orange/5 flex flex-col items-center gap-3 group"
                                    data-op="Wave">
                                    <div
                                        class="w-14 h-14 bg-white rounded-xl shadow-sm border border-black/5 flex items-center justify-center overflow-hidden p-2 group-hover:scale-110 transition-transform">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Wave_Logo_Blue.svg/1024px-Wave_Logo_Blue.svg.png"
                                            class="w-full h-full object-contain" alt="Wave">
                                    </div>
                                    <span class="text-xs font-bold uppercase tracking-widest">Wave</span>
                                </button>

                                <button type="button"
                                    class="operator-card p-4 bg-white border-2 border-premium-dark/5 rounded-2xl transition-all hover:bg-premium-orange/5 flex flex-col items-center gap-3 group"
                                    data-op="Orange">
                                    <div
                                        class="w-14 h-14 bg-white rounded-xl shadow-sm border border-black/5 flex items-center justify-center overflow-hidden p-2 group-hover:scale-110 transition-transform">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Orange_logo.svg/1024px-Orange_logo.svg.png"
                                            class="w-full h-full object-contain" alt="Orange">
                                    </div>
                                    <span class="text-xs font-bold uppercase tracking-widest">Orange</span>
                                </button>

                                <button type="button"
                                    class="operator-card p-4 bg-white border-2 border-premium-dark/5 rounded-2xl transition-all hover:bg-premium-orange/5 flex flex-col items-center gap-3 group"
                                    data-op="MTN">
                                    <div
                                        class="w-14 h-14 bg-white rounded-xl shadow-sm border border-black/5 flex items-center justify-center overflow-hidden p-2 group-hover:scale-110 transition-transform">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/MTN_Logo.svg/1024px-MTN_Logo.svg.png"
                                            class="w-full h-full object-contain" alt="MTN">
                                    </div>
                                    <span class="text-xs font-bold uppercase tracking-widest">MTN</span>
                                </button>

                                <button type="button"
                                    class="operator-card p-4 bg-white border-2 border-premium-dark/5 rounded-2xl transition-all hover:bg-premium-orange/5 flex flex-col items-center gap-3 group"
                                    data-op="Moov">
                                    <div
                                        class="w-14 h-14 bg-white rounded-xl shadow-sm border border-black/5 flex items-center justify-center overflow-hidden p-2 group-hover:scale-110 transition-transform">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz6HicBly3gq0uM76v-E7i7F0R9pIDfF7A2Q&s"
                                            class="w-full h-full object-contain" alt="Moov">
                                    </div>
                                    <span class="text-xs font-bold uppercase tracking-widest">Moov</span>
                                </button>
                            </div>
                        </div>

                        <div id="mobile-number-input" class="hidden animate-fade-in-up">
                            <div
                                class="bg-premium-dark p-10 rounded-[2.5rem] text-center space-y-6 relative overflow-hidden">
                                <div class="absolute inset-0 opacity-10 mix-blend-soft-light pointer-events-none"
                                    style="background-image: url('https://www.transparenttextures.com/patterns/az-subtle.png');">
                                </div>
                                <p class="text-white/60 text-sm font-bold uppercase tracking-widest">Entrez votre num√©ro
                                    <span id="display-op" class="text-premium-orange"></span>
                                </p>
                                <div class="max-w-xs mx-auto">
                                    <input type="tel" id="mobile-money-num" placeholder="00 00 00 00 00"
                                        class="w-full bg-white/10 border-2 border-white/10 px-6 py-4 rounded-2xl focus:bg-white focus:text-premium-dark outline-none transition-all text-center text-3xl tracking-widest font-extrabold text-white placeholder:text-white/10">
                                </div>
                                <div
                                    class="text-white/30 text-[10px] flex items-center justify-center gap-2 uppercase tracking-widest font-bold">
                                    <i class="fa-solid fa-lock text-premium-orange"></i> Connexion s√©curis√©e SSL 256-bit
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="btn-pay" disabled
                            class="w-full bg-premium-orange text-white font-bold py-5 rounded-2xl transition-all shadow-xl shadow-premium-orange/20 text-lg hover:bg-premium-dark active:scale-95 disabled:bg-premium-dark/10 disabled:text-premium-dark/20 disabled:shadow-none flex items-center justify-center gap-3 group">
                            <i class="fa-solid fa-shield-check group-hover:rotate-12 transition-transform"></i> Valider
                            et Payer
                        </button>
                    </div>

                    <div id="payment-cash" class="hidden animate-fade-in">
                        <div
                            class="bg-premium-light p-10 rounded-[3rem] border border-premium-dark/5 text-center space-y-6">
                            <div
                                class="w-20 h-20 bg-premium-orange/10 text-premium-orange rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-hand-holding-dollar text-3xl"></i>
                            </div>
                            <h3 class="text-2xl font-extrabold text-premium-dark">Paiement √† la livraison</h3>
                            <p class="text-premium-dark/40 max-w-sm mx-auto leading-relaxed">
                                Vous r√©glerez le montant total directement en esp√®ces lors de la r√©ception de votre
                                commande ou service.
                            </p>
                        </div>
                        <button type="submit"
                            class="w-full mt-10 bg-premium-dark text-white font-extrabold py-5 rounded-2xl hover:bg-premium-orange transition-all shadow-xl active:scale-95">
                            Confirmer ma commande
                        </button>
                    </div>

                    <div class="text-center">
                        <button type="button" id="btn-back"
                            class="text-xs font-bold text-premium-dark/40 hover:text-premium-orange uppercase tracking-widest transition-all inline-flex items-center gap-2 group">
                            <i class="fa-solid fa-chevron-left group-hover:-translate-x-1 transition-transform"></i>
                            Retour aux informations
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            const categorie = /*[[${produit.categorie}]]*/ '';
            const catLower = (categorie || '').toLowerCase();

            const fieldsVoiture = document.getElementById('fields-voiture');
            const fieldsResidence = document.getElementById('fields-residence');
            const fieldsPoulet = document.getElementById('fields-poulet');

            // üõ°Ô∏è Disable all specific inputs by default
            [fieldsVoiture, fieldsResidence, fieldsPoulet].forEach(section => {
                if (section) {
                    section.querySelectorAll('input').forEach(input => input.disabled = true);
                }
            });

            if (catLower.includes('voiture') || catLower.includes('v√©hicule')) {
                fieldsVoiture?.classList.remove('hidden');
                fieldsVoiture?.querySelectorAll('input').forEach(input => input.disabled = false);
            } else if (catLower.includes('residence') || catLower.includes('r√©sidence')) {
                fieldsResidence?.classList.remove('hidden');
                fieldsResidence?.querySelectorAll('input').forEach(input => input.disabled = false);
            } else if (catLower.includes('poulet')) {
                fieldsPoulet?.classList.remove('hidden');
                fieldsPoulet?.querySelectorAll('input').forEach(input => input.disabled = false);
            }

            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const btnNext = document.getElementById('btn-next');
            const btnBack = document.getElementById('btn-back');
            const progressBar = document.getElementById('progress-bar');
            const step2Indicator = document.getElementById('step-2-indicator');

            const paymentSelect = document.getElementById('payment-select');
            const paymentMobile = document.getElementById('payment-mobile');
            const paymentCash = document.getElementById('payment-cash');

            const operatorCards = document.querySelectorAll('.operator-card');
            const hiddenOp = document.getElementById('hidden-operateur');
            const mobileInputArea = document.getElementById('mobile-number-input');
            const displayOp = document.getElementById('display-op');
            const mobileMoneyNum = document.getElementById('mobile-money-num');
            const btnPay = document.getElementById('btn-pay');

            btnNext.addEventListener('click', () => {
                const inputNom = document.getElementById('input-nom');
                const inputTel = document.getElementById('input-tel');
                const inputLoc = document.getElementById('input-loc');

                if (!inputNom.value || !inputTel.value || !inputLoc.value) {
                    alert("Veuillez remplir les informations obligatoires.");
                    return;
                }

                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                step2Indicator.classList.remove('opacity-30');
                step2Indicator.querySelector('div').classList.add('bg-premium-orange', 'text-white', 'shadow-lg', 'shadow-premium-orange/20');
                step2Indicator.querySelector('div').classList.remove('bg-premium-dark/10', 'text-premium-dark/40');
                progressBar.classList.add('w-full');

                if (paymentSelect.value === 'TELEPHONE') {
                    paymentMobile.classList.remove('hidden');
                    paymentCash.classList.add('hidden');
                } else {
                    paymentCash.classList.remove('hidden');
                    paymentMobile.classList.add('hidden');
                }

                window.scrollTo({ top: 100, behavior: 'smooth' });
            });

            btnBack.addEventListener('click', () => {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
                step2Indicator.classList.add('opacity-30');
                step2Indicator.querySelector('div').classList.remove('bg-premium-orange', 'text-white', 'shadow-lg', 'shadow-premium-orange/20');
                step2Indicator.querySelector('div').classList.add('bg-premium-dark/10', 'text-premium-dark/40');
                progressBar.classList.remove('w-full');
            });

            operatorCards.forEach(card => {
                card.addEventListener('click', () => {
                    operatorCards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    const op = card.getAttribute('data-op');
                    hiddenOp.value = op;
                    displayOp.textContent = op;
                    mobileInputArea.classList.remove('hidden');
                    mobileMoneyNum.focus();
                    validateStep2();
                });
            });

            mobileMoneyNum.addEventListener('input', validateStep2);

            function validateStep2() {
                btnPay.disabled = !(hiddenOp.value && mobileMoneyNum.value.length >= 8);
            }

            // üîç DIAGNOSTIC: Log form submission and catch hidden errors
            const commandeForm = document.getElementById('commandeForm');
            if (commandeForm) {
                commandeForm.addEventListener('submit', (e) => {
                    console.log("Tentative de soumission du formulaire...");
                    const invalidFields = Array.from(commandeForm.querySelectorAll(':invalid'));
                    if (invalidFields.length > 0) {
                        console.error("Champs invalides d√©tect√©s :", invalidFields);
                        alert("Certains champs sont invalides ou manquants. V√©rifiez la console (F12) pour plus de d√©tails.");
                    }
                });
            }

            // üìç GEOLOCATION LOGIC
            const btnGeo = document.getElementById('btn-geolocation');
            const inputLoc = document.getElementById('input-loc');

            btnGeo?.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    alert("La g√©olocalisation n'est pas support√©e par votre navigateur.");
                    return;
                }

                const originalInner = btnGeo.innerHTML;
                btnGeo.disabled = true;
                btnGeo.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Localisation...';

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);
                            const data = await response.json();

                            if (data && data.display_name) {
                                inputLoc.value = data.display_name;
                                // Sauvegarder les coordonn√©es
                                document.getElementById('hidden-lat').value = latitude;
                                document.getElementById('hidden-lng').value = longitude;

                                // Animation de succ√®s
                                inputLoc.classList.add('ring-4', 'ring-green-500/10', 'border-green-500');
                                setTimeout(() => {
                                    inputLoc.classList.remove('ring-4', 'ring-green-500/10', 'border-green-500');
                                }, 2000);
                            } else {
                                alert("Impossible de d√©terminer l'adresse exacte. Voici vos coordonn√©es : " + latitude + ", " + longitude);
                                inputLoc.value = latitude + ", " + longitude;
                            }
                        } catch (error) {
                            console.error("Erreur Geocoding:", error);
                            inputLoc.value = latitude + ", " + longitude;
                        } finally {
                            btnGeo.disabled = false;
                            btnGeo.innerHTML = originalInner;
                        }
                    },
                    (error) => {
                        console.error("Erreur Geolocation:", error);
                        alert("Erreur de g√©olocalisation : " + error.message);
                        btnGeo.disabled = false;
                        btnGeo.innerHTML = originalInner;
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            });
        });
    </script>
</body>

</html>